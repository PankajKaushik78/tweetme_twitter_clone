{% extends "base.html" %}

{% block content %}

<div class="row text-center">
    <div class="col mt-3 mb-3">
        <h1>Welcome to Tweetme</h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4 col-10 mx-auto">
        <form action="/create-tweet" id="create-tweet-form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="next" value="/">
            <textarea name="content" class="form-control" placeholder="Your tweet..."></textarea>
            <button type="submit" class="btn btn-primary">Tweet</button>
        </form>
    </div>
</div>

<div class="row" id="tweets">
    Loading...
</div>


<script>
    const tweetsEl = document.querySelector("#tweets");
    const tweetCreateFormEl = document.querySelector("#create-tweet-form");


    tweetCreateFormEl.addEventListener("submit", tweetCreateFormSubmit);

    function tweetCreateFormSubmit(event) {
        event.preventDefault();
        const myForm = event.target;
        const myFormData = new FormData(myForm);
        const url = myForm.getAttribute("action"); //endpoint
        const method = myForm.getAttribute("method");
        const xhr = new XMLHttpRequest();
        xhr.open(method, url);
        xhr.onload = function () {
            const serverResponse = this.response;
            loadTweets(tweetsEl);
        }
        xhr.send(myFormData);
    }


    function loadTweets(tweetsElement) {
        const xhr = new XMLHttpRequest();
        const method = "GET";
        const url = "/tweets"; //endpoint
        const responseType = "json";

        //setting up xhr object
        xhr.responseType = responseType;
        xhr.open(method, url);
        xhr.onload = function () {
            const serverResponse = this.response;
            const listedTweets = serverResponse.response;
            var finalTweetStr = "";
            for (let tweet of listedTweets) {
                var currentTweet = formatTweetElement(tweet);
                finalTweetStr += currentTweet;
            }
            tweetsElement.innerHTML = finalTweetStr;
        }
        xhr.send();
    }

    loadTweets(tweetsEl);

    function formatTweetElement(tweet) {
        var formattedTweet = `<div class='col-12 col-md-10 mx-auto border rounded py-3 mb-4 tweet' id='tweet-${tweet.id}'>
                            <p> ${tweet.content} </p>
                            <div class='btn-group' >${likeBtn(tweet)} </div>
                            </div>`;
        return formattedTweet;
    }

    function likeBtn(tweet) {
        return `<button class='btn btn-primary' onclick=handleDidLike(${tweet.id},${tweet.likes})> 
                ${tweet.likes} Like
                </button>`;
    }

    function handleDidLike(tweet_id, currentCount) {
        console.log(tweet_id, currentCount);
    }

</script>

{% endblock %}